language: python
python:
    - "3.6"

services:
  - docker

cache: pip

before_install:
  - mkdir volume_mount
  - pip install awscli # Install AWS cli
  - export PATH=$PATH:$HOME/.local/bin # Add aws to the path.
  # Check that we can login. Requires AWS_ACCESS_KEY_ID and AWS_SECRET_ACCESS_KEY environmental variables.
  - eval $(aws ecr get-login --region us-east-1 --no-include-email)
  - docker build -t ferret .

script:
  # Run the ferret unit tests and mount a volume for gathering the coverage_output
  - docker run -v ferret_output:/usr/src/app/coverage_output -t ferret coverage run src/unit_tests.py

after_success:
  - pip install pyyaml coveralls
  # Check the contents of the docker volume.
  - docker run --rm -i -v=ferret_output:/home/travis/volume_mount busybox find /home/travis/volume_mount
  # Copy the coverage results file from the Docker container to Travis.
  - ./docker-volume-cp ferret_output:. /home/travis/
  - ls -alh /home/travis/
  #- docker cp ferret:/usr/src/app/$(docker exec -it ferret bash -c "ls -a .coverage.*" | tr -d '\r') ./
  # Merge the source paths between the newly copied coverage file and Travis.
  - coverage combine
  # Upload to coveralls.
  - coveralls